<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="csrf-token" content="{{ csrf_token() }}" />
    <title>Guardian AI | Deep Forensic QA</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.26.0/cytoscape.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>

    <style>
      :root {
        --primary: #6366f1;
        --secondary: #ec4899;
        --accent: #8b5cf6;
        --bg-body: #f0f4f8;
        --text-main: #0f172a;
        --text-muted: #64748b;
        --border: #e2e8f0;
        --success: #10b981;
        --danger: #ef4444;
        --warning: #f59e0b;
        --card-bg: #ffffff;
        --font-main: "Inter", sans-serif;
        --font-code: "JetBrains Mono", monospace;
        --radius-sm: 8px;
        --radius-md: 12px;
        --radius-lg: 16px;
        --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.06);
        --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.08);
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        outline: none;
        -webkit-tap-highlight-color: transparent;
      }

      body {
        font-family: var(--font-main);
        background: var(--bg-body);
        color: var(--text-main);
        height: 100vh;
        overflow: hidden;
        display: flex;
        background-image:
          radial-gradient(
            circle at 5% 10%,
            rgba(99, 102, 241, 0.07) 0%,
            transparent 30%
          ),
          radial-gradient(
            circle at 95% 90%,
            rgba(236, 72, 153, 0.07) 0%,
            transparent 30%
          );
      }

      ::-webkit-scrollbar {
        width: 5px;
        height: 5px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 10px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: var(--primary);
      }

      /* ── Layout ─────────────────────────────────── */
      .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-width: 0;
        overflow: hidden;
        position: relative;
      }

      .top-header {
        height: 64px;
        padding: 0 24px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: rgba(255, 255, 255, 0.92);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border-bottom: 1px solid var(--border);
        z-index: 40;
        gap: 12px;
        flex-shrink: 0;
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 10px;
        min-width: 0;
        flex: 1;
      }

      .hamburger-btn {
        display: none;
        background: none;
        border: none;
        font-size: 18px;
        color: var(--text-main);
        cursor: pointer;
        padding: 6px 8px;
        border-radius: 6px;
        flex-shrink: 0;
        transition: background 0.15s;
      }
      .hamburger-btn:hover {
        background: #f1f5f9;
      }

      .page-title {
        min-width: 0;
      }
      .page-title h2 {
        font-size: 16px;

        color: var(--text-main);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        line-height: 1.3;
      }
      .page-title p {
        font-size: 11px;
        color: var(--text-muted);
        margin-top: 1px;
        white-space: nowrap;
      }

      .run-status-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 11px;

        flex-shrink: 0;
      }

      .content-scroll {
        flex: 1;
        overflow-y: auto;
        padding: 24px;
        scroll-behavior: smooth;
      }
      .container-width {
        max-width: 1200px;
        margin: 0 auto;
      }

      /* ── Animations ─────────────────────────────── */
      .fade-in-up {
        animation: fadeInUp 0.45s ease-out forwards;
        opacity: 0;
      }
      .delay-1 {
        animation-delay: 0.08s;
      }
      .delay-2 {
        animation-delay: 0.16s;
      }
      .delay-3 {
        animation-delay: 0.24s;
      }
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(16px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      .hidden {
        display: none !important;
      }

      /* ── Scan Form Card ─────────────────────────── */
      .scan-card {
        background: var(--card-bg);
        border-radius: 20px;
        padding: 36px 40px;
        text-align: center;
        box-shadow: var(--shadow-md);
        max-width: 580px;
        margin: 16px auto 0;
        border: 1px solid var(--border);
        position: relative;
        overflow: hidden;
      }
      .scan-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 3px;
        background: linear-gradient(90deg, var(--primary), var(--secondary));
      }
      .scan-icon {
        width: 60px;
        height: 60px;
        background: rgba(99, 102, 241, 0.08);
        color: var(--primary);
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 26px;
        margin: 0 auto 18px;
        transition: transform 0.35s ease;
      }
      .scan-card:hover .scan-icon {
        transform: scale(1.08) rotate(8deg);
      }
      .scan-card h2 {
        font-size: 24px;
        font-weight: 800;
        margin-bottom: 10px;
        color: var(--text-main);
      }
      .scan-card > p {
        color: var(--text-muted);
        margin-bottom: 28px;
        font-size: 14px;
        line-height: 1.6;
      }

      .input-group {
        background: #f8fafc;
        border: 1.5px solid var(--border);
        border-radius: var(--radius-md);
        padding: 4px;
        display: flex;
        align-items: center;
        transition:
          border-color 0.2s,
          box-shadow 0.2s;
        margin-bottom: 12px;
      }
      .input-group:focus-within {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        background: var(--card-bg);
      }
      .input-icon {
        padding: 0 14px;
        color: var(--primary);
        opacity: 0.7;
        font-size: 14px;
        flex-shrink: 0;
      }
      .url-input {
        border: none;
        flex: 1;
        padding: 11px 8px 11px 0;
        font-size: 14px;
        background: transparent;
        font-family: var(--font-code);
        color: var(--text-main);
        min-width: 0;
      }

      /* ── Filter Panel ───────────────────────────── */
      .filter-section {
        border: 1.5px solid var(--border);
        border-radius: var(--radius-md);
        background: var(--card-bg);
        overflow: hidden;
        text-align: left;
        margin-bottom: 16px;
      }
      .filter-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 14px;
        cursor: pointer;
        font-size: 13px;

        background: #f8fafc;
        user-select: none;
        transition: background 0.15s;
      }
      .filter-header:hover {
        background: #f1f5f9;
      }
      .filter-count-badge {
        font-size: 10px;

        padding: 2px 8px;
        background: rgba(99, 102, 241, 0.1);
        color: var(--primary);
        border-radius: 20px;
      }
      .filter-body {
        padding: 12px 14px 14px;
        border-top: 1px solid #f1f5f9;
        display: none;
      }
      .filter-body.open {
        display: block;
        animation: fadeIn 0.25s;
      }
      .filter-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin: 0 0 4px;
        text-align: left;
      }
      /* Enhanced filter card with description line */
      .filter-chip {
        display: flex;
        flex-direction: column;
        gap: 4px;
        padding: 10px 12px;
        border: 1.5px solid var(--border);
        border-radius: var(--radius-sm);
        cursor: pointer;
        background: #fafafa;
        font-size: 12px;
        transition:
          border-color 0.15s,
          background 0.15s,
          transform 0.12s;
        color: var(--text-muted);
        user-select: none;
      }
      .filter-chip:hover {
        border-color: var(--primary);
        background: rgba(99, 102, 241, 0.03);
        transform: translateY(-1px);
      }
      .filter-chip input {
        display: none;
      }
      .filter-chip:has(input:checked) {
        border-color: var(--primary);
        background: rgba(99, 102, 241, 0.07);
        color: var(--primary);
      }
      .filter-chip-header {
        display: flex;
        align-items: center;
        gap: 7px;
        font-size: 12px;
        font-weight: 600;
        color: inherit;
      }
      .filter-chip-header i {
        color: var(--primary);
        font-size: 13px;
      }
      .filter-chip-desc {
        font-size: 10px;
        color: #94a3b8;
        line-height: 1.4;
        padding-left: 20px;
      }
      .filter-chip:has(input:checked) .filter-chip-header {
        color: var(--primary);
      }
      .weight-notice {
        margin-top: 10px;
        padding: 8px 12px;
        background: rgba(245, 158, 11, 0.07);
        border: 1px solid rgba(245, 158, 11, 0.2);
        border-radius: var(--radius-sm);
        font-size: 11px;
        color: #92400e;
        display: none;
      }
      /* ── Not Tested badge (filter-aware results) ─────── */
      .not-tested-badge {
        font-size: 10px;
        font-weight: 600;
        color: #94a3b8;
        background: #f1f5f9;
        padding: 2px 7px;
        border-radius: 20px;
        letter-spacing: 0.3px;
      }
      /* ── Active filter pills (shown above results) ────── */
      .active-filter-pills {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 6px;
        margin-bottom: 14px;
      }
      .pills-label {
        font-size: 11px;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .filter-pill {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        font-size: 11px;
        font-weight: 600;
        color: var(--primary);
        background: rgba(99, 102, 241, 0.1);
        border: 1px solid rgba(99, 102, 241, 0.2);
        padding: 3px 10px;
        border-radius: 20px;
      }
      .filter-pill i {
        font-size: 10px;
      }
      /* ── Confidence score tooltip ────────────────────── */
      .conf-tooltip-wrap {
        position: relative;
        display: inline-flex;
        align-items: center;
      }
      .conf-help-icon {
        font-size: 11px;
        color: #94a3b8;
        margin-left: 4px;
        cursor: help;
      }
      .conf-tooltip-text {
        display: none;
        position: absolute;
        bottom: 130%;
        left: 50%;
        transform: translateX(-50%);
        background: #1e293b;
        color: #e2e8f0;
        font-size: 11px;
        line-height: 1.5;
        padding: 8px 12px;
        border-radius: 8px;
        white-space: normal;
        width: 220px;
        z-index: 200;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        font-weight: 400;
        pointer-events: none;
      }
      .conf-tooltip-wrap:hover .conf-tooltip-text {
        display: block;
      }

      .start-btn {
        background: linear-gradient(135deg, var(--primary), #4f46e5);
        color: white;
        border: none;
        padding: 13px;
        border-radius: var(--radius-md);
        width: 100%;

        font-size: 15px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        transition:
          transform 0.2s,
          box-shadow 0.2s;
        box-shadow: 0 4px 14px rgba(99, 102, 241, 0.25);
      }
      .start-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 8px 20px rgba(99, 102, 241, 0.35);
      }
      .start-btn:disabled {
        opacity: 0.7;
        cursor: not-allowed;
        transform: none;
      }

      /* ── Progress Box ───────────────────────────── */
      .progress-box {
        margin-top: 20px;
        padding: 18px 20px;
        background: var(--card-bg);
        border-radius: var(--radius-md);
        border: 1px solid var(--border);
        box-shadow: var(--shadow-sm);
      }
      .progress-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }
      .progress-label {
        font-size: 13px;
        color: var(--text-main);
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .progress-percent {
        font-size: 14px;
        font-weight: 700;
        color: var(--primary);
        font-family: var(--font-code);
      }
      .progress-track {
        height: 6px;
        background: #e2e8f0;
        border-radius: 4px;
        overflow: hidden;
      }
      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--primary), var(--accent));
        transition: width 0.5s ease;
      }
      .progress-stats {
        display: flex;
        justify-content: space-between;
        font-size: 11px;

        color: var(--text-muted);
        margin-top: 8px;
      }

      /* ── Run Header ─────────────────────────────── */
      .run-header-card {
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        padding: 22px 24px;
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        align-items: center;
        margin-bottom: 20px;
        box-shadow: var(--shadow-sm);
      }
      .rh-main {
        flex: 1;
        min-width: 240px;
      }
      .rh-title {
        font-size: 17px;
        font-weight: 700;
        color: var(--text-main);
        margin-bottom: 8px;
        font-family: var(--font-code);
        word-break: break-all;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .rh-title i {
        color: var(--primary);
        font-size: 14px;
        flex-shrink: 0;
      }
      .rh-meta {
        font-size: 12px;
        color: var(--text-muted);
        display: flex;
        gap: 14px;
        flex-wrap: wrap;
      }
      .rh-meta span {
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .rh-score-box {
        text-align: center;
        padding: 0 20px;
        border-left: 1px solid var(--border);
        flex-shrink: 0;
      }
      .rh-score-lbl {
        font-size: 10px;

        text-transform: uppercase;
        color: var(--text-muted);
        letter-spacing: 0.5px;
        margin-bottom: 6px;
      }
      .rh-score-val {
        font-size: 34px;
        font-weight: 700;
        line-height: 1;
        font-family: var(--font-code);
      }
      .rh-risk {
        font-size: 12px;

        margin-top: 4px;
      }

      .conf-badge-large {
        display: inline-flex;
        align-items: center;
        gap: 7px;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 13px;

        border: 1.5px solid;
      }
      .conf-high {
        background: rgba(16, 185, 129, 0.1);
        color: #059669;
        border-color: rgba(16, 185, 129, 0.3);
      }
      .conf-mid {
        background: rgba(245, 158, 11, 0.1);
        color: #b45309;
        border-color: rgba(245, 158, 11, 0.3);
      }
      .conf-low {
        background: rgba(239, 68, 68, 0.1);
        color: #b91c1c;
        border-color: rgba(239, 68, 68, 0.3);
      }

      /* ── Metrics ────────────────────────────────── */
      .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 14px;
        margin-bottom: 20px;
      }
      .metric-card {
        background: var(--card-bg);
        padding: 18px;
        border-radius: var(--radius-md);
        border: 1px solid var(--border);
        box-shadow: var(--shadow-sm);
      }
      .metric-lbl {
        font-size: 11px;

        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.4px;
        margin-bottom: 8px;
      }
      .metric-val {
        font-size: 26px;
        font-weight: 700;
        color: var(--text-main);
        line-height: 1;
      }

      /* ── Component Scores ───────────────────────── */
      .comp-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 12px;
        margin-bottom: 20px;
      }
      .comp-card {
        background: var(--card-bg);
        border: 1px solid var(--border);
        padding: 16px;
        border-radius: var(--radius-md);
        text-align: center;
        box-shadow: var(--shadow-sm);
      }
      .comp-val {
        font-size: 22px;
        font-weight: 700;
        color: var(--text-main);
        font-family: var(--font-code);
        line-height: 1;
        margin-bottom: 6px;
      }
      .comp-lbl {
        font-size: 11px;

        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.3px;
      }

      /* ── AI Summary ─────────────────────────────── */
      .ai-summary {
        background: linear-gradient(135deg, #ffffff, #f8fafc);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        padding: 20px;
        margin-bottom: 20px;
        display: flex;
        gap: 16px;
        box-shadow: var(--shadow-sm);
      }
      .ai-summary-icon {
        width: 44px;
        height: 44px;
        background: linear-gradient(135deg, #8b5cf6, #d946ef);
        border-radius: var(--radius-sm);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        flex-shrink: 0;
        font-size: 18px;
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.25);
      }
      .ai-summary h4 {
        font-size: 14px;

        margin-bottom: 6px;
        color: var(--text-main);
      }
      .ai-summary-body {
        font-size: 13px;
        line-height: 1.65;
        color: var(--text-muted);
      }

      /* ── Page Results ───────────────────────────── */
      .pages-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 14px;
        flex-wrap: wrap;
        gap: 10px;
      }
      .pages-title {
        font-size: 15px;

        color: var(--text-main);
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .pages-title i {
        color: var(--primary);
      }
      .filter-btns {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
      }

      .pf-btn {
        font-size: 11px;

        padding: 5px 12px;
        border: 1.5px solid var(--border);
        border-radius: 20px;
        cursor: pointer;
        background: var(--card-bg);
        color: var(--text-muted);
        transition: all 0.15s;
      }
      .pf-btn:hover {
        border-color: var(--primary);
        color: var(--primary);
      }
      .pf-btn.active {
        background: var(--primary);
        border-color: var(--primary);
        color: white;
      }

      /* ── Page Row ───────────────────────────────── */
      .page-row {
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        margin-bottom: 8px;
        overflow: hidden;
        transition:
          border-color 0.15s,
          box-shadow 0.15s;
        box-shadow: var(--shadow-sm);
      }
      .page-row:hover {
        border-color: #c7d2fe;
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.08);
      }
      .page-row.open {
        border-color: var(--primary);
      }

      .pr-header {
        display: flex;
        align-items: center;
        padding: 14px 16px;
        cursor: pointer;
        gap: 14px;
        user-select: none;
        transition: background 0.1s;
      }
      .pr-header:hover {
        background: #fafbfc;
      }

      .pr-status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        flex-shrink: 0;
      }
      .pr-url {
        flex: 1;
        font-family: var(--font-code);
        font-size: 12px;

        color: #1e293b;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        min-width: 0;
      }
      .pr-meta {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-shrink: 0;
      }

      .score-pill {
        font-size: 11px;

        padding: 3px 9px;
        border-radius: 6px;
        font-family: var(--font-code);
      }
      .sp-exc {
        background: rgba(16, 185, 129, 0.12);
        color: #059669;
      }
      .sp-mid {
        background: rgba(245, 158, 11, 0.12);
        color: #b45309;
      }
      .sp-bad {
        background: rgba(239, 68, 68, 0.12);
        color: #b91c1c;
      }

      .conf-mini-bar {
        width: 44px;
        height: 5px;
        background: #e2e8f0;
        border-radius: 3px;
        overflow: hidden;
        display: inline-block;
        vertical-align: middle;
        margin-right: 5px;
      }
      .conf-mini-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--primary), var(--secondary));
        border-radius: 3px;
      }
      .conf-pct {
        font-family: var(--font-code);
        font-size: 11px;
      }

      .risk-label {
        font-size: 11px;

        width: 90px;
        text-align: right;
      }

      .chevron {
        transition: transform 0.2s;
        color: #94a3b8;
        font-size: 12px;
      }
      .page-row.open .chevron {
        transform: rotate(180deg);
      }

      /* ── Expanded Detail ────────────────────────── */
      .pr-body {
        border-top: 1px solid #f1f5f9;
        background: #fafafa;
        padding: 18px 16px;
        display: none;
      }
      .page-row.open .pr-body {
        display: block;
        animation: fadeIn 0.25s ease;
      }

      .pr-body-inner {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
      }
      .pr-body-main {
        flex: 1;
        min-width: 280px;
      }

      .detail-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 10px;
        margin-bottom: 14px;
      }
      .d-card {
        background: var(--card-bg);
        border: 1px solid var(--border);
        padding: 11px 12px;
        border-radius: var(--radius-sm);
      }
      .d-lbl {
        font-size: 10px;

        text-transform: uppercase;
        color: var(--text-muted);
        margin-bottom: 5px;
        display: flex;
        align-items: center;
        gap: 4px;
      }
      .d-val {
        font-weight: 700;
        font-family: var(--font-code);
        font-size: 17px;
        color: var(--text-main);
      }

      .issue-tags {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
        margin-bottom: 14px;
      }
      .issue-tag {
        font-size: 11px;

        padding: 3px 9px;
        border-radius: 5px;
      }

      .ai-insight {
        background: #eef2ff;
        border: 1px solid #c7d2fe;
        padding: 11px 14px;
        border-radius: var(--radius-sm);
        font-size: 12px;
        color: #3730a3;
        line-height: 1.55;
        margin-bottom: 12px;
      }

      .inspect-btn {
        padding: 9px 18px;
        background: var(--card-bg);
        border: 1.5px solid var(--border);
        border-radius: var(--radius-sm);
        color: var(--text-main);
        font-size: 13px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 7px;
        transition:
          border-color 0.15s,
          color 0.15s,
          background 0.15s;
      }
      .inspect-btn:hover {
        border-color: var(--primary);
        color: var(--primary);
        background: rgba(99, 102, 241, 0.04);
      }

      .page-screenshot {
        width: 200px;
        height: 115px;
        border-radius: var(--radius-sm);
        border: 1px solid var(--border);
        overflow: hidden;
        flex-shrink: 0;
        cursor: pointer;
        transition: box-shadow 0.15s;
      }
      .page-screenshot:hover {
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
      }
      .page-screenshot img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        object-position: top;
      }

      /* ── Modal ──────────────────────────────────── */
      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.55);
        backdrop-filter: blur(10px);
        z-index: 100;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.35s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }
      .modal-overlay.open {
        opacity: 1;
        pointer-events: auto;
      }

      .modal-window {
        background: #f8fafc;
        width: 100%;
        max-width: 1300px;
        height: 90vh;
        border-radius: 20px;
        box-shadow: 0 25px 60px -10px rgba(0, 0, 0, 0.35);
        transform: scale(0.96) translateY(16px);
        transition: transform 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      .modal-overlay.open .modal-window {
        transform: scale(1) translateY(0);
      }

      .modal-header {
        padding: 14px 22px;
        background: var(--card-bg);
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
      }
      .modal-header-left {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .modal-icon {
        width: 38px;
        height: 38px;
        background: linear-gradient(135deg, var(--primary), var(--accent));
        border-radius: 9px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 16px;
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.28);
        flex-shrink: 0;
      }
      .modal-title {
        font-size: 15px;

        color: var(--text-main);
      }
      .modal-id {
        font-size: 11px;

        color: var(--text-muted);
        text-transform: uppercase;
      }
      .close-modal {
        width: 34px;
        height: 34px;
        border-radius: 50%;
        border: none;
        background: #f1f5f9;
        cursor: pointer;
        color: #64748b;
        font-size: 14px;
        transition:
          background 0.2s,
          color 0.2s,
          transform 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .close-modal:hover {
        background: #fee2e2;
        color: #ef4444;
        transform: rotate(90deg);
      }
      .modal-body {
        flex: 1;
        overflow-y: auto;
        padding: 22px;
      }

      .modal-split {
        display: grid;
        grid-template-columns: 1fr;
        gap: 20px;
        height: 100%;
      }
      @media (min-width: 1024px) {
        .modal-split {
          grid-template-columns: 380px 1fr;
        }
      }

      .modal-left {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .screenshot-container {
        position: relative;
        border-radius: var(--radius-md);
        overflow: hidden;
        background: #0f172a;
        border: 3px solid var(--card-bg);
        aspect-ratio: 16/9;
        box-shadow: 0 8px 24px -4px rgba(0, 0, 0, 0.2);
      }
      .screenshot-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        object-position: top;
      }
      .screenshot-label {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(15, 23, 42, 0.75);
        backdrop-filter: blur(4px);
        color: white;
        font-family: var(--font-code);
        font-size: 9px;
        padding: 3px 7px;
        border-radius: 4px;
        border-left: 2px solid var(--success);
      }

      .context-box {
        background: var(--card-bg);
        padding: 16px;
        border-radius: var(--radius-md);
        border: 1px solid var(--border);
      }
      .context-heading {
        font-size: 10px;

        text-transform: uppercase;
        color: #94a3b8;
        margin-bottom: 12px;
        letter-spacing: 0.5px;
      }
      .context-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 9px 0;
        border-bottom: 1px dashed #e2e8f0;
        font-size: 13px;
      }
      .context-row:last-child {
        border: none;
        padding-bottom: 0;
      }
      .context-row-key {
        color: var(--text-muted);
        font-weight: 500;
      }
      .context-row-val {
        font-family: var(--font-code);

        font-size: 12px;
      }

      .modal-right {
        background: var(--card-bg);
        border-radius: var(--radius-md);
        border: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      .tabs-header {
        display: flex;
        border-bottom: 1px solid var(--border);
        background: var(--card-bg);
        overflow-x: auto;
        scrollbar-width: none;
      }
      .tabs-header::-webkit-scrollbar {
        display: none;
      }
      .tab-btn {
        padding: 12px 18px;
        border: none;
        background: transparent;
        font-size: 12px;

        color: #64748b;
        cursor: pointer;
        border-bottom: 2px solid transparent;
        text-transform: uppercase;
        letter-spacing: 0.4px;
        white-space: nowrap;
        transition:
          color 0.15s,
          border-color 0.15s,
          background 0.15s;
      }
      .tab-btn:hover {
        color: var(--primary);
        background: #f8fafc;
      }
      .tab-btn.active {
        color: var(--primary);
        border-bottom-color: var(--primary);
        background: #f8fafc;
      }
      .tab-pane {
        display: none;
        height: 100%;
        overflow-y: auto;
      }
      .tab-pane.active {
        display: block;
        animation: fadeIn 0.25s ease;
      }

      .tab-table {
        width: 100%;
        border-collapse: collapse;
      }
      .tab-table th {
        text-align: left;
        padding: 11px 14px;
        font-size: 10px;

        color: var(--text-muted);
        text-transform: uppercase;
        background: var(--card-bg);
        position: sticky;
        top: 0;
        z-index: 10;
        border-bottom: 1px solid var(--border);
        letter-spacing: 0.4px;
      }
      .tab-table td {
        padding: 11px 14px;
        font-size: 12px;
        border-bottom: 1px solid #f1f5f9;
        vertical-align: top;
      }

      /* ── Pagination ─────────────────────────────── */
      .pagination-bar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 4px 4px;
        margin-top: 8px;
        flex-wrap: wrap;
        gap: 8px;
      }
      .pagination-info {
        font-size: 12px;
        color: var(--text-muted);
      }
      .pagination-btns {
        display: flex;
        gap: 4px;
      }
      .pg-btn {
        min-width: 30px;
        height: 30px;
        border: 1.5px solid var(--border);
        background: var(--card-bg);
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        color: var(--text-muted);
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s;
        padding: 0 8px;
      }
      .pg-btn:hover:not(:disabled) {
        border-color: var(--primary);
        color: var(--primary);
      }
      .pg-btn.active {
        background: var(--primary);
        border-color: var(--primary);
        color: white;
      }
      .pg-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
      }

      /* ── URL actions ─────────────────────────────── */
      .pr-url-wrap {
        flex: 1;
        display: flex;
        align-items: center;
        gap: 6px;
        min-width: 0;
        overflow: hidden;
      }
      .pr-url-link {
        font-family: var(--font-code);
        font-size: 12px;
        color: #1e293b;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        text-decoration: none;
        transition: color 0.15s;
      }
      .pr-url-link:hover {
        color: var(--primary);
        text-decoration: underline;
      }
      .copy-url-btn {
        flex-shrink: 0;
        width: 22px;
        height: 22px;
        border: 1px solid var(--border);
        border-radius: 5px;
        background: var(--card-bg);
        color: var(--text-muted);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        transition: all 0.15s;
        opacity: 0;
      }
      .pr-header:hover .copy-url-btn {
        opacity: 1;
      }
      .copy-url-btn:hover {
        background: #eef2ff;
        border-color: var(--primary);
        color: var(--primary);
      }
      .copy-url-btn.copied {
        background: #dcfce7;
        border-color: var(--success);
        color: var(--success);
      }

      /* ── Delete scan modal ───────────────────────── */
      .delete-modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.6);
        backdrop-filter: blur(8px);
        z-index: 200;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.25s;
        padding: 20px;
      }
      .delete-modal-overlay.open {
        opacity: 1;
        pointer-events: auto;
      }
      .delete-modal-box {
        background: white;
        border-radius: 18px;
        padding: 28px 30px;
        max-width: 420px;
        width: 100%;
        box-shadow: 0 20px 50px -8px rgba(0, 0, 0, 0.3);
        transform: scale(0.93) translateY(12px);
        transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        text-align: center;
      }
      .delete-modal-overlay.open .delete-modal-box {
        transform: scale(1) translateY(0);
      }
      .delete-modal-icon {
        width: 52px;
        height: 52px;
        background: #fee2e2;
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 22px;
        color: var(--danger);
        margin: 0 auto 16px;
      }
      .delete-modal-box h3 {
        font-size: 18px;
        font-weight: 700;
        color: var(--text-main);
        margin-bottom: 8px;
      }
      .delete-modal-box p {
        font-size: 13px;
        color: var(--text-muted);
        line-height: 1.6;
        margin-bottom: 22px;
      }
      .delete-modal-url {
        font-family: var(--font-code);
        font-size: 11px;
        background: #f8fafc;
        border: 1px solid var(--border);
        border-radius: 6px;
        padding: 6px 10px;
        color: var(--text-main);
        word-break: break-all;
        margin-bottom: 22px;
        display: block;
        text-align: left;
      }
      .delete-modal-actions {
        display: flex;
        gap: 10px;
      }
      .dm-cancel-btn {
        flex: 1;
        padding: 11px;
        border: 1.5px solid var(--border);
        border-radius: 10px;
        background: white;
        color: var(--text-main);
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.15s;
      }
      .dm-cancel-btn:hover {
        background: #f8fafc;
        border-color: #94a3b8;
      }
      .dm-confirm-btn {
        flex: 1;
        padding: 11px;
        border: none;
        border-radius: 10px;
        background: var(--danger);
        color: white;
        font-size: 14px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.15s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 7px;
      }
      .dm-confirm-btn:hover {
        background: #dc2626;
        box-shadow: 0 4px 14px rgba(239, 68, 68, 0.35);
      }
      .dm-confirm-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      /* ── Delete scan button in run header ────────── */
      .delete-scan-btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 7px 14px;
        border: 1.5px solid #fecaca;
        border-radius: 8px;
        background: white;
        color: #ef4444;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.15s;
        flex-shrink: 0;
      }
      .delete-scan-btn:hover {
        background: #fee2e2;
        border-color: var(--danger);
        box-shadow: 0 2px 8px rgba(239, 68, 68, 0.15);
      }

      /* ── Error banner ────────────────────────────── */
      .error-banner {
        background: #fef2f2;
        border: 1px solid #fecaca;
        border-radius: var(--radius-md);
        padding: 12px 16px;
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 13px;
        color: #b91c1c;
        margin-bottom: 16px;
        animation: fadeInUp 0.3s ease-out;
      }
      .error-banner i {
        flex-shrink: 0;
        font-size: 15px;
      }

      /* ── Progress smooth animation ───────────────── */
      .progress-fill {
        transition: width 0.4s ease !important;
      }

      /* ── Table improvements ──────────────────────── */
      .tab-table tbody tr:hover {
        background: #f8fafc;
      }
      .tab-table th {
        white-space: nowrap;
      }

      /* ── Responsive ─────────────────────────────── */
      @media (max-width: 900px) {
        .comp-grid {
          grid-template-columns: repeat(3, 1fr);
        }
      }
      @media (max-width: 768px) {
        .hamburger-btn {
          display: block;
        }
        .content-scroll {
          padding: 16px;
        }
        .scan-card {
          padding: 28px 22px;
        }
        .comp-grid {
          grid-template-columns: repeat(2, 1fr);
        }
        .metrics-grid {
          grid-template-columns: repeat(2, 1fr);
        }
        .pr-meta {
          gap: 8px;
        }
        .risk-label {
          display: none;
        }
        .rh-score-box {
          border-left: none;
          padding-left: 0;
        }
      }
      @media (max-width: 480px) {
        .comp-grid {
          grid-template-columns: 1fr 1fr;
        }
        .metrics-grid {
          grid-template-columns: 1fr 1fr;
        }
        .page-screenshot {
          display: none;
        }
      }

      /* ── Live Scan Panel ─────────────────────────────── */
      .live-scan-panel {
        background: var(--card-bg);
        border: 1.5px solid #c7d2fe;
        border-radius: var(--radius-lg);
        padding: 24px 28px 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 16px rgba(99, 102, 241, 0.07);
      }
      .lsp-header {
        display: flex;
        align-items: center;
        gap: 14px;
        margin-bottom: 18px;
        flex-wrap: wrap;
      }
      .lsp-radar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--primary), var(--accent));
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-size: 17px;
        flex-shrink: 0;
      }
      .lsp-title {
        font-size: 15px;
        font-weight: 700;
        color: var(--text-main);
      }
      .lsp-url {
        font-size: 12px;
        color: var(--text-muted);
        font-family: var(--font-code);
        margin-top: 2px;
        word-break: break-all;
      }
      .lsp-badge {
        margin-left: auto;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
        font-weight: 600;
        padding: 5px 12px;
        border-radius: 20px;
      }
      .lsp-badge.running {
        background: #eff6ff;
        color: #3b82f6;
        border: 1px solid #bfdbfe;
      }
      .lsp-badge.queued {
        background: #fffbeb;
        color: #d97706;
        border: 1px solid #fde68a;
      }
      .lsp-badge.failed {
        background: #fef2f2;
        color: #ef4444;
        border: 1px solid #fecaca;
      }
      .lsp-progress-labels {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 7px;
        font-size: 12px;
        color: var(--text-muted);
      }
      .lsp-pct {
        font-size: 14px;
        font-weight: 700;
        color: var(--primary);
        font-family: var(--font-code);
      }
      .lsp-track {
        height: 8px;
        background: #e2e8f0;
        border-radius: 6px;
        overflow: hidden;
        margin-bottom: 16px;
      }
      .lsp-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--primary), var(--accent));
        border-radius: 6px;
        transition: width 0.4s ease;
        min-width: 4px;
      }
      .lsp-stats {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 12px;
        margin-bottom: 14px;
      }
      @media (max-width: 600px) {
        .lsp-stats {
          grid-template-columns: repeat(2, 1fr);
        }
      }
      .lsp-stat {
        background: #f8fafc;
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        padding: 10px 12px;
        text-align: center;
      }
      .lsp-stat-val {
        font-size: 20px;
        font-weight: 700;
        font-family: var(--font-code);
        color: var(--text-main);
        line-height: 1;
      }
      .lsp-stat-lbl {
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--text-muted);
        margin-top: 4px;
      }
      .lsp-hint {
        font-size: 12px;
        color: var(--text-muted);
        display: flex;
        align-items: center;
        gap: 6px;
        padding-top: 10px;
        border-top: 1px solid var(--border);
      }
      .placeholder-section {
        background: var(--card-bg);
        border: 1px dashed var(--border);
        border-radius: var(--radius-md);
        padding: 32px;
        text-align: center;
        color: var(--text-muted);
        margin-bottom: 16px;
        font-size: 13px;
      }
      .placeholder-section i {
        font-size: 24px;
        margin-bottom: 10px;
        display: block;
        opacity: 0.4;
      }
    </style>
  </head>
  <body>
    {% include "partials/sidebar.html" %}

    <main class="main-content">
      <header class="top-header">
        <div class="header-left">
          <button class="hamburger-btn" onclick="toggleSidebar()">
            <i class="fa-solid fa-bars"></i>
          </button>
          <div class="page-title">
            <h2 id="page-title-text">
              {% if current_run %}{{ current_run.target_url }}{% else %}New Deep
              Scan{% endif %}
            </h2>
            <p>
              {% if current_run and current_run.finished_at %}Scan completed: {{
              current_run.finished_at.strftime("%Y-%m-%d %H:%M") }} {% elif
              current_run %}Scan in progress... {% else %}Ready for input{%
              endif %}
            </p>
          </div>
        </div>

        {% if current_run %}
        <span
          class="run-status-badge"
          style="background: {% if current_run.status == 'completed' %}#ecfdf5{% else %}#eff6ff{% endif %}; color: {% if current_run.status == 'completed' %}#059669{% else %}#3b82f6{% endif %}; border: 1px solid {% if current_run.status == 'completed' %}#d1fae5{% else %}#bfdbfe{% endif %};"
        >
          {% if current_run.status == 'completed' %}<i
            class="fa-solid fa-check"
          ></i
          >{% else %}<i class="fa-solid fa-spinner fa-spin"></i>{% endif %} {{
          current_run.status|upper }}
        </span>
        <input type="hidden" id="currentRunId" value="{{ current_run.id }}" />
        <input
          type="hidden"
          id="currentRunStatus"
          value="{{ current_run.status }}"
        />
        {% endif %}
      </header>

      <div class="content-scroll">
        <div class="container-width">
          <!-- ═══ View: New Scan Form ═══ -->
          <div
            id="view-new-test"
            class="view-section {% if data or current_run %}hidden{% endif %}"
          >
            <div class="scan-card fade-in-up">
              <div class="scan-icon"><i class="fa-solid fa-radar"></i></div>
              <h2>Initiate Deep Scan</h2>
              <p>
                Enter a target URL below. The Guardian Engine will map the
                topology, extract UI definitions, and run deep heuristics.
              </p>

              <form id="auditForm" method="POST" action="/">
                <input
                  type="hidden"
                  name="csrf_token"
                  value="{{ csrf_token() }}"
                />
                <div class="input-group">
                  <span class="input-icon"
                    ><i class="fa-solid fa-globe"></i
                  ></span>
                  <input
                    type="url"
                    name="url"
                    id="urlInput"
                    class="url-input"
                    placeholder="https://example.com"
                    required
                  />
                </div>
                <div class="input-group">
                  <span class="input-icon"
                    ><i class="fa-solid fa-layer-group"></i
                  ></span>
                  <input
                    type="number"
                    name="page_limit"
                    class="url-input"
                    placeholder="Max pages to scan (default: plan limit)"
                    min="1"
                  />
                </div>

                <div class="filter-section">
                  <div
                    class="filter-header"
                    onclick="
                      document
                        .getElementById('filterBody')
                        .classList.toggle('open')
                    "
                  >
                    <span style="display: flex; align-items: center; gap: 8px">
                      <i
                        class="fa-solid fa-sliders"
                        style="color: var(--primary)"
                      ></i>
                      Scan Components
                    </span>
                    <span id="filterCount" class="filter-count-badge"
                      >6 / 6 active</span
                    >
                  </div>
                  <div class="filter-body open" id="filterBody">
                    <div class="filter-grid" id="filterGrid">
                      {% for fdef in scan_filter_defs %}
                      <label class="filter-chip">
                        <input
                          type="checkbox"
                          name="scan_filters"
                          value="{{ fdef.key }}"
                          {%
                          if
                          not
                          active_filters
                          or
                          fdef.key
                          in
                          active_filters
                          %}checked{%
                          endif
                          %}
                          onchange="updateFilterCount()"
                        />
                        <div class="filter-chip-header">
                          <i
                            class="{{ filter_icons.get(fdef.key, 'fa-solid fa-circle-check') }}"
                          ></i>
                          {{ fdef.label }}
                        </div>
                        <div class="filter-chip-desc">{{ fdef.desc }}</div>
                      </label>
                      {% endfor %}
                    </div>
                    <div id="weightNotice" class="weight-notice">
                      <i class="fa-solid fa-circle-info"></i> Scoring weights
                      automatically redistributed across selected components.
                    </div>
                  </div>
                </div>

                <button type="submit" id="submitBtn" class="start-btn">
                  <span id="btnText">Start Analysis</span>
                  <i class="fa-solid fa-arrow-right" id="btnIcon"></i>
                  <span id="btnSpinner" style="display: none">
                    <i class="fa-solid fa-circle-notch fa-spin"></i>
                  </span>
                </button>

                <div
                  id="progressBox"
                  class="progress-box"
                  style="display: none"
                >
                  <div class="progress-header">
                    <div class="progress-label">
                      <i
                        class="fa-solid fa-circle-notch fa-spin"
                        style="color: var(--primary)"
                      ></i>
                      Live Crawl in Progress
                    </div>
                    <span id="progressPercent" class="progress-percent"
                      >0%</span
                    >
                  </div>
                  <div class="progress-track">
                    <div
                      id="progressBar"
                      class="progress-fill"
                      style="width: 0%"
                    ></div>
                  </div>
                  <div class="progress-stats">
                    <span
                      >Scanned:
                      <strong id="statScanned" style="color: var(--text-main)"
                        >0</strong
                      ></span
                    >
                    <span
                      >Remaining:
                      <strong id="statRemaining" style="color: var(--text-main)"
                        >—</strong
                      ></span
                    >
                    <span
                      >ETA:
                      <strong id="statETA" style="color: var(--primary)"
                        >Calculating...</strong
                      ></span
                    >
                  </div>
                </div>
              </form>
            </div>
          </div>

          <!-- ═══ View: Run Results ═══ -->
          <div
            id="view-dashboard"
            class="view-section {% if not data and not current_run %}hidden{% endif %}"
          >
            {% if current_run %} {%- if current_run.status in ('running',
            'queued') %}
            <div class="live-scan-panel fade-in-up" id="liveScanPanel">
              <div class="lsp-header">
                <div class="lsp-radar">
                  <i class="fa-solid fa-radar fa-spin"></i>
                </div>
                <div>
                  <div class="lsp-title">Live Crawl in Progress</div>
                  <div class="lsp-url">{{ current_run.target_url }}</div>
                </div>
                <span
                  class="lsp-badge {{ current_run.status }}"
                  id="lspStatusBadge"
                >
                  <i class="fa-solid fa-circle-notch fa-spin"></i>
                  <span id="lspStatusText"
                    >{{ current_run.status | upper }}</span
                  >
                </span>
              </div>
              <div>
                <div class="lsp-progress-labels">
                  <span>Crawling pages&hellip;</span>
                  <span class="lsp-pct" id="lspPercent"
                    >{{ current_run.progress or 0 }}%</span
                  >
                </div>
                <div class="lsp-track">
                  <div
                    class="lsp-fill"
                    id="lspBar"
                    style="width:{{ current_run.progress or 0 }}%"
                  ></div>
                </div>
              </div>
              <div class="lsp-stats">
                <div class="lsp-stat">
                  <div class="lsp-stat-val" id="lspScanned">
                    {{ current_run.scanned_pages or 0 }}
                  </div>
                  <div class="lsp-stat-lbl">Scanned</div>
                </div>
                <div class="lsp-stat">
                  <div class="lsp-stat-val" id="lspDiscovered">
                    {{ current_run.discovered_pages or '&mdash;' }}
                  </div>
                  <div class="lsp-stat-lbl">Discovered</div>
                </div>
                <div class="lsp-stat">
                  <div class="lsp-stat-val" id="lspRemaining">&mdash;</div>
                  <div class="lsp-stat-lbl">Remaining</div>
                </div>
                <div class="lsp-stat">
                  <div class="lsp-stat-val" id="lspETA" style="font-size: 14px">
                    Calculating&hellip;
                  </div>
                  <div class="lsp-stat-lbl">ETA</div>
                </div>
              </div>
              <p class="lsp-hint">
                <i class="fa-solid fa-circle-info"></i> Results will load
                automatically when the scan completes &mdash; no refresh needed.
              </p>
            </div>
            {%- endif %}

            <!-- Run Header -->
            <div class="run-header-card fade-in-up delay-1">
              <div class="rh-main">
                <div class="rh-title">
                  <i class="fa-solid fa-link"></i>
                  <a
                    href="{{ current_run.target_url }}"
                    target="_blank"
                    rel="noopener noreferrer"
                    style="color: inherit; text-decoration: none"
                    title="Open target URL in new tab"
                    >{{ current_run.target_url }}</a
                  >
                </div>
                <div class="rh-meta">
                  <span
                    ><i class="fa-regular fa-clock"></i> {{
                    current_run.finished_at.strftime("%Y-%m-%d %H:%M") if
                    current_run.finished_at else 'Active' }}</span
                  >
                  <span
                    ><i class="fa-solid fa-layer-group"></i> {{ raw_data|length
                    if raw_data else 0 }} Pages</span
                  >
                </div>
              </div>

              {% set conf = current_run.confidence_score %}
              <div class="rh-score-box">
                <div class="rh-score-lbl">
                  Data Confidence
                  <span class="conf-tooltip-wrap">
                    <i class="fa-solid fa-circle-info conf-help-icon"></i>
                    <span class="conf-tooltip-text">
                      Confidence reflects how many checks returned real data vs.
                      null.<br />
                      Lower = more scan errors or skipped checks.<br />
                      Higher = all selected engines ran successfully.
                    </span>
                  </span>
                </div>
                {% if conf is not none %}
                <div
                  class="conf-badge-large {% if conf >= 80 %}conf-high{% elif conf >= 50 %}conf-mid{% else %}conf-low{% endif %}"
                >
                  <i class="fa-solid fa-shield-check"></i> {{ conf|round(1) }}%
                </div>
                {% else %}
                <div style="font-size: 14px; color: var(--text-muted)">N/A</div>
                {% endif %}
              </div>

              {% set hs = current_run.site_health_score %}
              <div
                class="rh-score-box"
                style="border-right: none; padding-right: 0"
              >
                <div class="rh-score-lbl">Composite Health</div>
                {% if hs is not none %}
                <div
                  class="rh-score-val"
                  style="color: {% if hs>=80 %}var(--success){% elif hs>=50 %}var(--warning){% else %}var(--danger){% endif %};"
                >
                  {{ hs|round(1) }}
                </div>
                <div
                  class="rh-risk"
                  style="color: {% if hs>=80 %}var(--success){% elif hs>=50 %}var(--warning){% else %}var(--danger){% endif %};"
                >
                  {{ current_run.risk_category }}
                </div>
                {% else %}
                <div class="rh-score-val" style="color: var(--text-muted)">
                  —
                </div>
                {% endif %}
              </div>

              {% if current_run.status == 'completed' or current_run.status ==
              'failed' %} {% endif %}
            </div>

            <!-- Key Metrics / Placeholder while scanning -->
            {% if current_run.status in ('running', 'queued') and not raw_data
            %}
            <div class="placeholder-section fade-in-up delay-2">
              <i class="fa-solid fa-hourglass-half"></i>
              Scan metrics and per-page results will appear here once pages have
              been analyzed.
            </div>
            {% else %}
            <div class="metrics-grid fade-in-up delay-2">
              <div class="metric-card">
                <div class="metric-lbl">Total Analyzed</div>
                <div class="metric-val">
                  {% if metrics and metrics.get('total_pages') is not none %}{{
                  metrics.get('total_pages') }}{% else %}—{% endif %}
                </div>
              </div>
              <div class="metric-card">
                <div class="metric-lbl">Passed</div>
                <div class="metric-val" style="color: var(--success)">
                  {% if metrics and metrics.get('active_pages') is not none %}{{
                  metrics.get('active_pages') }}{% else %}—{% endif %}
                </div>
              </div>
              <div class="metric-card">
                <div class="metric-lbl">Broken Links</div>
                <div class="metric-val" style="color: var(--danger)">
                  {% if metrics and metrics.get('not_found_pages') is not none
                  %}{{ metrics.get('not_found_pages') }}{% else %}—{% endif %}
                </div>
              </div>
              <div class="metric-card">
                <div class="metric-lbl">Avg Load Time</div>
                <div class="metric-val">
                  {% if metrics and metrics.get('avg_load_time') is not none
                  %}{{ "%.2f"|format(metrics.get('avg_load_time')) }}s{% else
                  %}—{% endif %}
                </div>
              </div>
            </div>

            <!-- Component Scores -->
            <div class="comp-grid fade-in-up delay-2">
              {% for k, v, c in [('Performance',
              current_run.avg_performance_score, '#6366f1'), ('Accessibility',
              current_run.avg_accessibility_score, '#10b981'), ('Security',
              current_run.avg_security_score, '#f59e0b'), ('Functional',
              current_run.avg_functional_score, '#ec4899'), ('UI / Form',
              current_run.avg_ui_form_score, '#3b82f6')] %}
              <div class="comp-card" style="border-top: 3px solid {{ c }};">
                <div class="comp-val">
                  {{ v|round(1) if v is not none else '—' }}
                </div>
                <div class="comp-lbl">{{ k }}</div>
              </div>
              {% endfor %}
            </div>

            <!-- AI Summary -->
            {% if ai_insight %}
            <div class="ai-summary fade-in-up delay-3">
              <div class="ai-summary-icon">
                <i class="fa-solid fa-wand-magic-sparkles"></i>
              </div>
              <div>
                <h4>AI Executive Summary</h4>
                <div class="ai-summary-body">{{ ai_insight|safe }}</div>
              </div>
            </div>
            {% endif %}

            <!-- Dashboard Intelligence Panel -->
            

            <!-- Per-Page Results -->
            <div class="fade-in-up delay-3">
              {% if active_filters %}
              <div class="active-filter-pills">
                <span class="pills-label">Scanned with:</span>
                {% for f in active_filters %}
                <span class="filter-pill">
                  <i class="{{ filter_icons.get(f, 'fa-solid fa-check') }}"></i>
                  {{ f | replace('_', ' ') | title }}
                </span>
                {% endfor %}
              </div>
              {% endif %}
              <div class="pages-header">
                <div class="pages-title">
                  <i class="fa-solid fa-list-check"></i> Per-Page Results
                </div>
                <div class="filter-btns">
                  <button
                    class="pf-btn active"
                    onclick="filterPages('all', this)"
                  >
                    All
                  </button>
                  <button
                    class="pf-btn"
                    onclick="filterPages('Critical', this)"
                  >
                    Critical
                  </button>
                  <button
                    class="pf-btn"
                    onclick="filterPages('Needs Attention', this)"
                  >
                    Attention
                  </button>
                  <button class="pf-btn" onclick="filterPages('Good', this)">
                    Good
                  </button>
                </div>
              </div>

              <div id="pageRowsContainer">
                {% for p in raw_data %} {% set phs = p.get('health_score') %} {%
                set prisk = p.get('risk_category') or 'Unknown' %} {% set pconf
                = p.get('confidence_score') %} {% set pstat = p.get('status') %}

                <div class="page-row" data-risk="{{ prisk }}" data-page-item>
                  <div
                    class="pr-header"
                    onclick="this.parentElement.classList.toggle('open')"
                  >
                    <div
                      class="pr-status-dot"
                      style="background: {% if pstat == 200 %}var(--success){% elif pstat == 404 %}var(--danger){% else %}var(--warning){% endif %};"
                      title="HTTP {{ pstat }}"
                    ></div>
                    <div class="pr-url-wrap">
                      <a
                        href="{{ p.get('url','') }}"
                        target="_blank"
                        rel="noopener noreferrer"
                        class="pr-url-link"
                        title="Open {{ p.get('url','') }} in new tab"
                        onclick="event.stopPropagation()"
                      >
                        {{ p.get('url','') }}
                      </a>
                      <button
                        class="copy-url-btn"
                        data-copy-url="{{ p.get('url','') }}"
                        onclick="copyUrl(this, this.dataset.copyUrl, event)"
                        title="Copy URL"
                        aria-label="Copy URL to clipboard"
                      >
                        <i class="fa-regular fa-copy"></i>
                      </button>
                    </div>
                    <div class="pr-meta">
                      {% if phs is not none %}
                      <span
                        class="score-pill {% if phs>=80 %}sp-exc{% elif phs>=50 %}sp-mid{% else %}sp-bad{% endif %}"
                        >{{ phs|round(1) }}</span
                      >
                      {% endif %} {% if pconf is not none %}
                      <div
                        style="display: flex; align-items: center"
                        title="Data Confidence: {{ pconf|round(1) }}%"
                      >
                        <div class="conf-mini-bar">
                          <div
                            class="conf-mini-fill"
                            style="width: {{ pconf }}%;"
                          ></div>
                        </div>
                        <span class="conf-pct">{{ pconf|int }}%</span>
                      </div>
                      {% endif %}
                      <span
                        class="risk-label"
                        style="color: {% if prisk=='Excellent' %}#059669{% elif prisk=='Good' %}var(--primary){% elif prisk=='Needs Attention' %}#b45309{% else %}#b91c1c{% endif %};"
                        >{{ prisk }}</span
                      >
                      <i class="fa-solid fa-chevron-down chevron"></i>
                    </div>
                  </div>
                  <div class="pr-body">
                    <div class="pr-body-inner">
                      <div class="pr-body-main">
                        <div class="detail-grid">
                          <div class="d-card">
                            <div class="d-lbl">
                              <i class="fa-solid fa-gauge-high"></i> Perf
                            </div>
                            <div class="d-val">
                              {% if p.get('performance_score') is not none %} {{
                              p.get('performance_score')|round(1) }} {% elif not
                              active_filters or 'performance' in active_filters
                              %} — {% else %}
                              <span class="not-tested-badge">Not Tested</span>
                              {% endif %}
                            </div>
                          </div>
                          <div class="d-card">
                            <div class="d-lbl">
                              <i class="fa-solid fa-universal-access"></i> A11y
                            </div>
                            <div class="d-val">
                              {% if p.get('accessibility_score') is not none %}
                              {{ p.get('accessibility_score')|round(1) }} {%
                              elif not active_filters or 'accessibility' in
                              active_filters %} — {% else %}
                              <span class="not-tested-badge">Not Tested</span>
                              {% endif %}
                            </div>
                          </div>
                          <div class="d-card">
                            <div class="d-lbl">
                              <i class="fa-solid fa-shield-halved"></i> Sec
                            </div>
                            <div class="d-val">
                              {% if p.get('security_score') is not none %} {{
                              p.get('security_score')|round(1) }} {% elif not
                              active_filters or 'security' in active_filters %}
                              — {% else %}
                              <span class="not-tested-badge">Not Tested</span>
                              {% endif %}
                            </div>
                          </div>
                          <div class="d-card">
                            <div class="d-lbl">
                              <i class="fa-solid fa-link"></i> Func
                            </div>
                            <div class="d-val">
                              {% if p.get('functional_score') is not none %} {{
                              p.get('functional_score')|round(1) }} {% elif not
                              active_filters or 'functional' in active_filters
                              %} — {% else %}
                              <span class="not-tested-badge">Not Tested</span>
                              {% endif %}
                            </div>
                          </div>
                        </div>

                        <div class="issue-tags">
                          {% set a11yc = p.get('accessibility_issues') or 0 %}
                          {% set bl = p.get('broken_links') or [] %} {% set jsl
                          = p.get('js_errors') or [] %}
                          <span
                            class="issue-tag"
                            style="background: {% if a11yc>0 %}#fef3c7; color:#b45309{% else %}#dcfce7; color:#166534{% endif %}"
                            >{{ a11yc }} A11y Issues</span
                          >
                          <span
                            class="issue-tag"
                            style="background: {% if bl|length>0 %}#fee2e2; color:#b91c1c{% else %}#dcfce7; color:#166534{% endif %}"
                            >{{ bl|length }} Broken Links</span
                          >
                          <span
                            class="issue-tag"
                            style="background: {% if jsl|length>0 %}#fee2e2; color:#b91c1c{% else %}#dcfce7; color:#166534{% endif %}"
                            >{{ jsl|length }} JS Errors</span
                          >
                          <span
                            class="issue-tag"
                            style="background: #f1f5f9; color: #475569"
                            >Load: {{ "%.2f"|format(p.get('load_time'))
                            }}s</span
                          >
                        </div>

                        <button
                          class="inspect-btn"
                          onclick="openModal({{ loop.index0 }})"
                        >
                          <i
                            class="fa-solid fa-microscope"
                            style="color: var(--primary)"
                          ></i>
                          Open Deep Inspection
                        </button>
                      </div>

                      {% if p.get('screenshot') %}
                      <div
                        class="page-screenshot"
                        onclick="window.open('/{{ p.screenshot }}','_blank')"
                      >
                        <img
                          src="/{{ p.get('screenshot') }}"
                          alt="Page screenshot"
                        />
                      </div>
                      {% endif %}
                    </div>
                  </div>
                </div>
                {% endfor %}
              </div>

              <!-- Pagination bar for page results -->
              <div
                id="pageResultsPagination"
                class="pagination-bar"
                style="display: none"
              >
                <div class="pagination-info" id="pgInfo"></div>
                <div class="pagination-btns" id="pgBtns"></div>
              </div>
            </div>
            {% endif %}{# data ready #} {% endif %}{# current_run #}
          </div>
        </div>
      </div>
    </main>

    <!-- ═══ Delete Scan Confirmation Modal ═══ -->
    <div id="deleteModal" class="delete-modal-overlay">
      <div class="delete-modal-box">
        <div class="delete-modal-icon">
          <i class="fa-solid fa-trash-can"></i>
        </div>
        <h3>Delete Scan?</h3>
        <p>
          This will permanently remove all data, reports, and page results. This
          action cannot be undone.
        </p>
        <span class="delete-modal-url" id="deleteModalUrl">—</span>
        <div class="delete-modal-actions">
          <button class="dm-cancel-btn" onclick="closeDeleteModal()">
            Cancel
          </button>
          <button
            class="dm-confirm-btn"
            id="dmConfirmBtn"
            onclick="confirmDeleteScan()"
          >
            <i class="fa-solid fa-trash"></i> Delete Permanently
          </button>
        </div>
      </div>
    </div>

    <!-- ═══ Deep Inspection Modal ═══ -->
    <div id="detailsModal" class="modal-overlay">
      <div class="modal-window">
        <div class="modal-header">
          <div class="modal-header-left">
            <div class="modal-icon"><i class="fa-solid fa-microscope"></i></div>
            <div>
              <div class="modal-title">Deep Inspection Viewer</div>
              <div class="modal-id" id="modalId">--</div>
            </div>
          </div>
          <button onclick="closeModal()" class="close-modal">
            <i class="fa-solid fa-times"></i>
          </button>
        </div>
        <div id="modalContent" class="modal-body"></div>
      </div>
    </div>

    <!-- Hidden source data for modal -->
    <div class="hidden">
      {% if raw_data %} {% for item in raw_data %}
      <div id="source-{{ loop.index0 }}">
        <div class="modal-split">
          <div class="modal-left">
            <div class="screenshot-container">
              <img
                src="/{{ item.screenshot }}"
                class="screenshot-img"
                alt="Screenshot"
              />
              <div class="screenshot-label">
                {{ item.viewport or 'Desktop' }}
              </div>
            </div>

            <div class="context-box">
              <div class="context-heading">Execution Context</div>
              <div class="context-row">
                <span class="context-row-key">Status</span>
                <span
                  class="context-row-val"
                  style="color: {% if item.status==200 %}var(--success){% else %}var(--danger){% endif %};"
                  >{{ item.status }}</span
                >
              </div>
              <div class="context-row">
                <span class="context-row-key">Latency</span>
                <span class="context-row-val"
                  >{{ item.dom_latency or item.load_time }}ms</span
                >
              </div>
              <div class="context-row">
                <span class="context-row-key">Pattern</span>
                <span class="context-row-val"
                  >{{ item.failure_pattern or 'None' }}</span
                >
              </div>
            </div>
          </div>

          <div class="modal-right">
            <div class="tabs-header">
              <button
                onclick="switchModalTab('ui', {{ loop.index0 }})"
                id="tab-btn-ui-{{ loop.index0 }}"
                class="tab-btn active"
              >
                <i class="fa-solid fa-layer-group" style="margin-right: 6px"></i
                >UI Elements
              </button>
              <button
                onclick="switchModalTab('forms', {{ loop.index0 }})"
                id="tab-btn-forms-{{ loop.index0 }}"
                class="tab-btn"
              >
                <i class="fa-solid fa-wpforms" style="margin-right: 6px"></i
                >Forms
              </button>
              <button
                onclick="switchModalTab('broken', {{ loop.index0 }})"
                id="tab-btn-broken-{{ loop.index0 }}"
                class="tab-btn"
              >
                <i class="fa-solid fa-link-slash" style="margin-right: 6px"></i
                >Broken Links
              </button>
              <button
                onclick="switchModalTab('graph', {{ loop.index0 }})"
                id="tab-btn-graph-{{ loop.index0 }}"
                class="tab-btn"
              >
                <i
                  class="fa-solid fa-network-wired"
                  style="margin-right: 6px"
                ></i
                >Topology
              </button>
            </div>

            <div
              style="
                flex: 1;
                overflow-y: auto;
                position: relative;
                background: #fff;
              "
            >
              <div
                id="tab-content-ui-{{ loop.index0 }}"
                class="tab-pane active"
              >
                <table class="tab-table">
                  <thead>
                    <tr>
                      <th>Element</th>
                      <th>XPath</th>
                      <th style="text-align: center">Visible</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for el in item.ui_elements %}
                    <tr>
                      <td>
                        <span
                          style="
                            font-family: var(--font-code);
                            font-size: 10px;
                            padding: 2px 6px;
                            background: #eef2ff;
                            border-radius: 4px;

                            color: var(--primary);
                          "
                          >{{ el.tag }}</span
                        >
                        <div
                          style="
                            font-size: 12px;
                            font-weight: 500;
                            margin-top: 4px;
                            max-width: 150px;
                            overflow: hidden;
                            text-overflow: ellipsis;
                            white-space: nowrap;
                            color: var(--text-muted);
                          "
                        >
                          {{ el.text or "No Text" }}
                        </div>
                      </td>
                      <td>
                        <code
                          style="
                            font-family: var(--font-code);
                            font-size: 10px;
                            color: #6366f1;
                            background: #eef2ff;
                            padding: 2px 5px;
                            border-radius: 4px;
                            display: block;
                            max-width: 180px;
                            overflow: hidden;
                            text-overflow: ellipsis;
                            white-space: nowrap;
                          "
                          title="{{ el.xpath }}"
                          >{{ el.xpath }}</code
                        >
                      </td>
                      <td style="text-align: center">
                        {% if el.visible %}<i
                          class="fa-solid fa-eye"
                          style="color: var(--success)"
                        ></i
                        >{% else %}<i
                          class="fa-solid fa-eye-slash"
                          style="color: #cbd5e1"
                        ></i
                        >{% endif %}
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>

              <div
                id="tab-content-forms-{{ loop.index0 }}"
                class="tab-pane"
                style="padding: 18px"
              >
                {% if item.forms and item.forms|length > 0 %} {% for form in
                item.forms %}
                <div
                  style="
                    margin-bottom: 14px;
                    border: 1px solid var(--border);
                    padding: 12px;
                    border-radius: var(--radius-sm);
                  "
                >
                  <div style="font-size: 13px; margin-bottom: 4px">
                    Method: {{ form.method }} · Fields: {{ form.fields_count }}
                  </div>
                  <div
                    style="
                      font-size: 11px;
                      color: var(--text-muted);
                      margin-bottom: 8px;
                      word-break: break-all;
                    "
                  >
                    Action: {{ form.action }}
                  </div>
                  <ul
                    style="
                      font-size: 12px;
                      padding-left: 18px;
                      margin: 0;
                      line-height: 1.7;
                    "
                  >
                    {% for field in form.fields %}
                    <li>
                      {{ field.tag }} | {{ field.type }} | {{ field.name }} {%
                      if field.required %}<strong style="color: var(--danger)"
                        >(req)</strong
                      >{% endif %}
                    </li>
                    {% endfor %}
                  </ul>
                </div>
                {% endfor %} {% else %}
                <p style="color: #94a3b8; font-size: 13px">
                  No forms detected.
                </p>
                {% endif %}
              </div>

              <div
                id="tab-content-broken-{{ loop.index0 }}"
                class="tab-pane"
                style="padding: 18px"
              >
                {% if item.broken_links and item.broken_links|length > 0 %}
                <ul
                  style="
                    font-size: 13px;
                    line-height: 1.7;
                    padding-left: 18px;
                    margin: 0;
                  "
                >
                  {% for link in item.broken_links %}
                  <li style="margin-bottom: 8px">
                    <span style="color: var(--danger); font-weight: 700"
                      >{{ link.status }}</span
                    >
                    — <span style="word-break: break-all">{{ link.url }}</span>
                  </li>
                  {% endfor %}
                </ul>
                {% else %}
                <p style="color: #94a3b8; font-size: 13px">
                  No broken links detected.
                </p>
                {% endif %}
              </div>

              <div id="tab-content-graph-{{ loop.index0 }}" class="tab-pane">
                <div
                  style="
                    width: 100%;
                    height: 100%;
                    background: #0f172a;
                    position: relative;
                    overflow: hidden;
                    min-height: 400px;
                  "
                >
                  <div
                    style="
                      position: absolute;
                      top: 12px;
                      right: 12px;
                      z-index: 20;
                      color: rgba(255, 255, 255, 0.35);
                      font-size: 10px;
                      pointer-events: none;
                      letter-spacing: 0.5px;
                    "
                  >
                    <i class="fa-solid fa-mouse-pointer"></i> SCROLL TO ZOOM
                  </div>
                  <div
                    id="cy-{{ loop.index0 }}"
                    style="width: 100%; height: 100%"
                  ></div>
                  <textarea id="graph-data-{{ loop.index0 }}" class="hidden">
{{ (item.connected_pages or []) | tojson }}</textarea
                  >
                  <input
                    type="hidden"
                    id="root-url-{{ loop.index0 }}"
                    value="{{ item.url }}"
                  />
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      {% endfor %} {% endif %}
    </div>

    <script>
      // ── Filter Logic ───────────────────────────────
      function updateFilterCount() {
        const total = document.querySelectorAll(
          "#filterGrid input[type=checkbox]",
        ).length;
        const checked = document.querySelectorAll(
          "#filterGrid input[type=checkbox]:checked",
        ).length;
        document.getElementById("filterCount").textContent =
          checked + " / " + total + " active";
        document.getElementById("weightNotice").style.display =
          checked < total && checked > 0 ? "block" : "none";
        document.querySelectorAll(".filter-chip").forEach((chip) => {
          chip.style.opacity = chip.querySelector("input").checked
            ? "1"
            : "0.55";
        });
      }

      function filterPages(risk, btn) {
        document
          .querySelectorAll(".pf-btn")
          .forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        document.querySelectorAll("[data-page-item]").forEach((row) => {
          row.style.display =
            risk === "all" || row.dataset.risk === risk ? "block" : "none";
        });
      }

      // ── Form Submit ────────────────────────────────
      document
        .getElementById("auditForm")
        .addEventListener("submit", function () {
          document.getElementById("btnText").textContent = "Starting scan...";
          document.getElementById("btnIcon").style.display = "none";
          document.getElementById("btnSpinner").style.display = "inline";
          document.getElementById("submitBtn").disabled = true;
        });

      // ── Progress Polling ───────────────────────────
      let _pollFailCount = 0;
      function startProgressPolling(runId) {
        const progressBox = document.getElementById("progressBox");
        if (progressBox) progressBox.style.display = "block";

        const interval = setInterval(async () => {
          try {
            const res = await fetch(`/api/run/${runId}/progress`);
            if (!res.ok) throw new Error("HTTP " + res.status);
            const d = await res.json();
            _pollFailCount = 0;

            const pct = d.progress || 0;
            const bar = document.getElementById("progressBar");
            if (bar) bar.style.width = pct + "%";
            const pctBadge = document.getElementById("progressPercent");
            if (pctBadge) pctBadge.textContent = pct + "%";

            const statScanned = document.getElementById("statScanned");
            if (statScanned) statScanned.textContent = d.scanned || 0;
            const statRemaining = document.getElementById("statRemaining");
            if (statRemaining)
              statRemaining.textContent =
                d.remaining !== null && d.remaining !== undefined
                  ? d.remaining
                  : "—";
            const statETA = document.getElementById("statETA");
            if (statETA) {
              if (d.eta_seconds === null || d.eta_seconds === undefined) {
                statETA.textContent = "Calculating...";
              } else if (d.eta_seconds <= 0) {
                statETA.textContent = "Almost done";
              } else {
                const m = Math.floor(d.eta_seconds / 60);
                const s = Math.round(d.eta_seconds % 60);
                statETA.textContent = m > 0 ? `${m}m ${s}s` : `${s}s`;
              }
            }

            // ── Also update live-scan panel if present ────
            const lspBar = document.getElementById("lspBar");
            if (lspBar) lspBar.style.width = pct + "%";
            const lspPct = document.getElementById("lspPercent");
            if (lspPct) lspPct.textContent = pct + "%";
            const lspScanned = document.getElementById("lspScanned");
            if (lspScanned)
              lspScanned.textContent = d.scanned_pages || d.scanned || 0;
            const lspDisc = document.getElementById("lspDiscovered");
            if (lspDisc)
              lspDisc.textContent =
                d.discovered_pages || d.discovered
                  ? d.discovered_pages || d.discovered
                  : "—";
            const disc2 = d.discovered_pages || d.discovered || 0;
            const sc2 = d.scanned_pages || d.scanned || 0;
            const rem2 = disc2 > 0 ? Math.max(0, disc2 - sc2) : null;
            const lspRem = document.getElementById("lspRemaining");
            if (lspRem) lspRem.textContent = rem2 !== null ? rem2 : "—";
            const lspETA = document.getElementById("lspETA");
            if (lspETA)
              lspETA.textContent =
                d.eta_seconds == null
                  ? "Calculating…"
                  : d.eta_seconds <= 0
                    ? "Almost done"
                    : Math.floor(d.eta_seconds / 60) > 0
                      ? Math.floor(d.eta_seconds / 60) +
                        "m " +
                        Math.round(d.eta_seconds % 60) +
                        "s"
                      : Math.round(d.eta_seconds) + "s";
            const lspStatus = document.getElementById("lspStatusText");
            if (lspStatus)
              lspStatus.textContent = (d.status || "").toUpperCase();
            const lspBadge = document.getElementById("lspStatusBadge");
            if (lspBadge) {
              lspBadge.className = "lsp-badge " + (d.status || "running");
            }

            if (d.status === "completed" || d.status === "failed") {
              clearInterval(interval);
              if (d.status === "failed") {
                _showErrorBanner(
                  "Scan failed. Some pages may not have been analyzed.",
                );
                setTimeout(() => location.reload(), 2000);
              } else {
                location.reload();
              }
            }
          } catch (err) {
            _pollFailCount++;
            console.warn("Progress poll error:", err);
            if (_pollFailCount >= 5) {
              clearInterval(interval);
              _showErrorBanner(
                "Lost connection to scan progress. Please refresh the page.",
              );
            }
          }
        }, 1500); // 1.5s live polling
      }

      document.addEventListener("DOMContentLoaded", () => {
        const runningEl = document.getElementById("currentRunId");
        const statusEl = document.getElementById("currentRunStatus");
        if (runningEl && statusEl) {
          const runId = runningEl.value;
          const status = statusEl.value;
          if (runId && (status === "running" || status === "queued")) {
            document.getElementById("progressBox").style.display = "block";
            startProgressPolling(runId);
          }
        }
      });

      // ── Modal Logic ────────────────────────────────
      const modal = document.getElementById("detailsModal");
      const modalContent = document.getElementById("modalContent");

      function openModal(index) {
        const sourceDiv = document.getElementById(`source-${index}`);
        if (!sourceDiv) return;
        modalContent.innerHTML = sourceDiv.innerHTML;
        document.getElementById("modalId").innerText = `ID: RAW-${index}`;
        modal.classList.add("open");
        document.body.style.overflow = "hidden";

        setTimeout(() => {
          if (modalContent.querySelector(`#tab-btn-ui-${index}`)) {
            switchModalTab("ui", index);
          }
        }, 50);
      }

      function closeModal() {
        modal.classList.remove("open");
        document.body.style.overflow = "";
        setTimeout(() => {
          modalContent.innerHTML = "";
        }, 400);
      }

      function switchModalTab(tabName, index) {
        const contentArea = document.getElementById("modalContent");
        contentArea
          .querySelectorAll(".tab-pane")
          .forEach((p) => p.classList.remove("active"));
        contentArea
          .querySelectorAll(".tab-btn")
          .forEach((b) => b.classList.remove("active"));
        const targetPane = contentArea.querySelector(
          `#tab-content-${tabName}-${index}`,
        );
        if (targetPane) targetPane.classList.add("active");
        const targetBtn = contentArea.querySelector(
          `#tab-btn-${tabName}-${index}`,
        );
        if (targetBtn) targetBtn.classList.add("active");
        if (tabName === "graph")
          setTimeout(() => {
            initGraph(index);
            if (window._cy) window._cy.resize();
          }, 100);
      }

      // ── Cytoscape Graph ────────────────────────────
      function initGraph(index) {
        const container = document
          .getElementById("modalContent")
          .querySelector(`#cy-${index}`);
        if (!container || container.getAttribute("data-initialized") === "true")
          return;

        const rootUrlVal = document
          .getElementById("modalContent")
          .querySelector(`#root-url-${index}`).value;
        const rawLinksVal = document
          .getElementById("modalContent")
          .querySelector(`#graph-data-${index}`).value;
        let links = [];
        try {
          links = JSON.parse(rawLinksVal);
        } catch (e) {
          console.error("JSON Parse Error", e);
        }

        const elements = [
          {
            data: {
              id: "root",
              label: "Target",
              fullUrl: rootUrlVal,
              type: "root",
            },
          },
        ];
        links.forEach((link, i) => {
          const id = `node${i}`;
          elements.push({ data: { id: id, label: link, type: "child" } });
          elements.push({ data: { source: "root", target: id } });
        });

        const cy = cytoscape({
          container: container,
          elements: elements,
          wheelSensitivity: 0.2,
          style: [
            {
              selector: "node",
              style: {
                "background-color": "#6366f1",
                width: "20px",
                height: "20px",
                label: "data(label)",
                "font-size": "0px",
                color: "#fff",
                "text-outline-color": "#0f172a",
                "text-outline-width": 2,
                "text-valign": "bottom",
                "text-margin-y": 8,
                "transition-property":
                  "background-color, width, height, border-width",
                "transition-duration": "0.3s",
              },
            },
            {
              selector: 'node[type="root"]',
              style: {
                "background-color": "#ec4899",
                width: "40px",
                height: "40px",
                "border-width": 4,
                "border-color": "rgba(236,72,153,0.3)",
                label: "ROOT",
              },
            },
            {
              selector: "edge",
              style: {
                width: 1,
                "line-color": "#334155",
                "curve-style": "bezier",
                "target-arrow-shape": "none",
                "transition-property": "line-color, width",
                "transition-duration": "0.3s",
              },
            },
            {
              selector: ".highlighted",
              style: {
                "background-color": "#38bdf8",
                "line-color": "#38bdf8",
                width: 3,
                "z-index": 9999,
              },
            },
            {
              selector: "node.highlighted",
              style: {
                width: "28px",
                height: "28px",
                "font-size": "11px",
                "font-family": "var(--font-code)",
              },
            },
            { selector: ".faded", style: { opacity: 0.1, "z-index": 0 } },
          ],
          layout: {
            name: "cose",
            animate: true,
            animationDuration: 1000,
            padding: 50,
            componentSpacing: 100,
            nodeRepulsion: 400000,
            edgeElasticity: 100,
            nestingFactor: 5,
            gravity: 80,
            numIter: 1000,
          },
        });

        cy.on("mouseover", "node", function (e) {
          const node = e.target;
          cy.elements().addClass("faded");
          node
            .neighborhood()
            .add(node)
            .removeClass("faded")
            .addClass("highlighted");
          container.style.cursor = "pointer";
        });
        cy.on("mouseout", "node", function () {
          cy.elements().removeClass("faded highlighted");
          container.style.cursor = "default";
        });
        cy.resize();
        window._cy = cy;
        container.setAttribute("data-initialized", "true");
      }

      document.addEventListener("keydown", function (event) {
        if (event.key === "Escape") closeModal();
      });
      // ── URL Copy ──────────────────────────────────
      function copyUrl(btn, url, event) {
        if (event) {
          event.preventDefault();
          event.stopPropagation();
        }
        if (!url) return;
        navigator.clipboard
          .writeText(url)
          .then(() => {
            btn.innerHTML = '<i class="fa-solid fa-check"></i>';
            btn.classList.add("copied");
            setTimeout(() => {
              btn.innerHTML = '<i class="fa-regular fa-copy"></i>';
              btn.classList.remove("copied");
            }, 1800);
          })
          .catch(() => {
            // Fallback for older browsers
            const el = document.createElement("textarea");
            el.value = url;
            el.style.position = "fixed";
            el.style.opacity = "0";
            document.body.appendChild(el);
            el.select();
            document.execCommand("copy");
            document.body.removeChild(el);
            btn.innerHTML = '<i class="fa-solid fa-check"></i>';
            btn.classList.add("copied");
            setTimeout(() => {
              btn.innerHTML = '<i class="fa-regular fa-copy"></i>';
              btn.classList.remove("copied");
            }, 1800);
          });
      }

      // ── Delete Scan Modal ──────────────────────────
      let _deleteTargetId = null;

      function openDeleteModal(runId, runUrl) {
        _deleteTargetId = runId;
        document.getElementById("deleteModalUrl").textContent = runUrl || "—";
        const btn = document.getElementById("dmConfirmBtn");
        btn.disabled = false;
        btn.innerHTML = '<i class="fa-solid fa-trash"></i> Delete Permanently';
        document.getElementById("deleteModal").classList.add("open");
        document.body.style.overflow = "hidden";
      }

      function closeDeleteModal() {
        document.getElementById("deleteModal").classList.remove("open");
        document.body.style.overflow = "";
        _deleteTargetId = null;
      }

      async function confirmDeleteScan() {
        if (!_deleteTargetId) return;
        const btn = document.getElementById("dmConfirmBtn");
        btn.disabled = true;
        btn.innerHTML =
          '<i class="fa-solid fa-circle-notch fa-spin"></i> Deleting...';

        const csrfToken = document.querySelector(
          'meta[name="csrf-token"]',
        ).content;
        try {
          const res = await fetch(`/run/${_deleteTargetId}/delete`, {
            method: "POST",
            headers: { "X-CSRFToken": csrfToken },
          });
          if (res.ok) {
            // Redirect to new scan or dashboard
            window.location.href = "/new-scan";
          } else {
            btn.disabled = false;
            btn.innerHTML =
              '<i class="fa-solid fa-trash"></i> Delete Permanently';
            _showErrorBanner("Failed to delete scan. Please try again.");
            closeDeleteModal();
          }
        } catch (err) {
          btn.disabled = false;
          btn.innerHTML =
            '<i class="fa-solid fa-trash"></i> Delete Permanently';
          _showErrorBanner("Network error. Please check your connection.");
          closeDeleteModal();
        }
      }

      // Close delete modal on overlay click
      document
        .getElementById("deleteModal")
        .addEventListener("click", function (e) {
          if (e.target === this) closeDeleteModal();
        });

      // ── Error Banner ──────────────────────────────
      function _showErrorBanner(msg) {
        let banner = document.getElementById("errorBanner");
        if (!banner) {
          banner = document.createElement("div");
          banner.id = "errorBanner";
          banner.className = "error-banner";
          const main = document.querySelector(
            ".content-scroll .container-width",
          );
          if (main) main.insertBefore(banner, main.firstChild);
        }
        banner.innerHTML = `<i class="fa-solid fa-circle-exclamation"></i><span>${msg}</span>
          <button onclick="this.parentElement.remove()" style="margin-left:auto;background:none;border:none;cursor:pointer;color:inherit;font-size:16px;">×</button>`;
        banner.style.display = "flex";
        setTimeout(() => {
          if (banner.parentElement) banner.remove();
        }, 6000);
      }

      // ── Pagination for Per-Page Results ───────────
      (function initPagePagination() {
        const container = document.getElementById("pageRowsContainer");
        if (!container) return;

        const PER_PAGE = 25;
        let currentPage = 1;
        let visibleItems = [];

        function getItems() {
          return Array.from(container.querySelectorAll("[data-page-item]"));
        }

        function refreshPagination() {
          const items = getItems();
          // Filter by currently visible (respecting risk filter)
          visibleItems = items.filter((el) => el.style.display !== "none");

          const totalPages = Math.ceil(visibleItems.length / PER_PAGE);
          currentPage = Math.min(currentPage, Math.max(1, totalPages));

          // Show/hide items
          visibleItems.forEach((el, i) => {
            const page = Math.floor(i / PER_PAGE) + 1;
            el.style.display = page === currentPage ? "block" : "none";
          });

          const paginationBar = document.getElementById(
            "pageResultsPagination",
          );
          const pgInfo = document.getElementById("pgInfo");
          const pgBtns = document.getElementById("pgBtns");

          if (visibleItems.length <= PER_PAGE) {
            paginationBar.style.display = "none";
            // Show all
            visibleItems.forEach((el) => (el.style.display = "block"));
            return;
          }

          paginationBar.style.display = "flex";
          const start = (currentPage - 1) * PER_PAGE + 1;
          const end = Math.min(currentPage * PER_PAGE, visibleItems.length);
          pgInfo.textContent = `Showing ${start}–${end} of ${visibleItems.length} pages`;

          // Build page buttons
          pgBtns.innerHTML = "";
          const prevBtn = document.createElement("button");
          prevBtn.className = "pg-btn";
          prevBtn.innerHTML = '<i class="fa-solid fa-chevron-left"></i>';
          prevBtn.disabled = currentPage === 1;
          prevBtn.addEventListener("click", () => {
            currentPage--;
            refreshPagination();
            scrollToResults();
          });
          pgBtns.appendChild(prevBtn);

          // Page numbers (show up to 7 pages centered around current)
          const range = [];
          for (let p = 1; p <= totalPages; p++) {
            if (
              p === 1 ||
              p === totalPages ||
              (p >= currentPage - 2 && p <= currentPage + 2)
            ) {
              range.push(p);
            }
          }
          let last = 0;
          range.forEach((p) => {
            if (last && p - last > 1) {
              const ellipsis = document.createElement("span");
              ellipsis.textContent = "…";
              ellipsis.style.cssText =
                "padding: 0 4px; color: #94a3b8; font-size:12px; display:flex; align-items:center;";
              pgBtns.appendChild(ellipsis);
            }
            const btn = document.createElement("button");
            btn.className = "pg-btn" + (p === currentPage ? " active" : "");
            btn.textContent = p;
            btn.addEventListener("click", () => {
              currentPage = p;
              refreshPagination();
              scrollToResults();
            });
            pgBtns.appendChild(btn);
            last = p;
          });

          const nextBtn = document.createElement("button");
          nextBtn.className = "pg-btn";
          nextBtn.innerHTML = '<i class="fa-solid fa-chevron-right"></i>';
          nextBtn.disabled = currentPage === totalPages;
          nextBtn.addEventListener("click", () => {
            currentPage++;
            refreshPagination();
            scrollToResults();
          });
          pgBtns.appendChild(nextBtn);
        }

        function scrollToResults() {
          const el = document.getElementById("pageRowsContainer");
          if (el) el.scrollIntoView({ behavior: "smooth", block: "start" });
        }

        // Hook into existing filterPages function
        const origFilter = window.filterPages;
        window.filterPages = function (risk, btn) {
          if (origFilter) origFilter(risk, btn);
          currentPage = 1;
          setTimeout(refreshPagination, 10);
        };

        // Initialize
        refreshPagination();
      })();
    </script>
  </body>
</html>