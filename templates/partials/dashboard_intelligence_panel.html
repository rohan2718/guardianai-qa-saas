{# ── Dashboard Intelligence Panel
────────────────────────────────────────────── Included in index.html after the
AI Summary block. Requires: `intel` dict from build_dashboard_intelligence() in
app.py context. Requires: Chart.js loaded in
<head>
  (already added to index.html) #} {% if intel %} {# ── Crawl Coverage Banner
  ──────────────────────────────────────────────────── #} {% set cov =
  intel.get('crawl_coverage', {}) %} {% if cov %}
  <div
    class="intel-banner {% if cov.coverage_pct < 60 %}intel-banner--warn{% elif cov.coverage_pct < 90 %}intel-banner--caution{% else %}intel-banner--ok{% endif %} fade-in-up delay-3"
  >
    <i class="fa-solid fa-radar"></i>
    <strong>Crawl Coverage:</strong>
    {{ cov.pages_scanned }} / {{ cov.pages_discovered }} pages scanned ({{
    cov.coverage_pct }}%) {% if cov.capped_by_limit %}
    <span class="intel-tag">⚠ Capped at {{ cov.page_limit }}-page limit</span>
    {% endif %}
  </div>
  {% endif %}

  <div class="intel-section-title fade-in-up delay-3">
    <i class="fa-solid fa-brain"></i> Site Intelligence
  </div>

  <div class="intel-grid fade-in-up delay-3">
    {# ── Severity Distribution Chart
    ──────────────────────────────────────────── #} {% set dist =
    intel.get('severity_dist', {}) %}
    <div class="intel-card intel-card--chart">
      <div class="intel-card__title">
        <i class="fa-solid fa-chart-pie"></i> Severity Distribution
      </div>
      <canvas id="severityChart" width="200" height="200"></canvas>
      <script>
        (function() {
          var ctx = document.getElementById('severityChart');
          if (!ctx || !window.Chart) return;
          new Chart(ctx.getContext('2d'), {
            type: 'doughnut',
            data: {
              labels: ['Excellent','Good','Needs Attention','Critical','Unknown'],
              datasets: [{
                data: [
                  {{ dist.get('Excellent', 0) }},
                  {{ dist.get('Good', 0) }},
                  {{ dist.get('Needs Attention', 0) }},
                  {{ dist.get('Critical', 0) }},
                  {{ dist.get('Unknown', 0) }}
                ],
                backgroundColor: ['#10b981','#84cc16','#f59e0b','#ef4444','#94a3b8'],
                borderWidth: 3,
                borderColor: '#ffffff',
              }]
            },
            options: {
              plugins: {
                legend: { position: 'bottom', labels: { color: '#475569', font: { size: 11 }, padding: 8 } }
              },
              cutout: '60%',
            }
          });
        })();
      </script>
    </div>

    {# ── Component Score Variance
    ─────────────────────────────────────────────── #} {% set var =
    intel.get('score_variance', {}) %}
    <div class="intel-card">
      <div class="intel-card__title">
        <i class="fa-solid fa-chart-bar"></i> Score Variance
      </div>
      <table class="intel-table">
        <thead>
          <tr>
            <th>Dimension</th>
            <th>Mean</th>
            <th>StdDev</th>
            <th>Min</th>
          </tr>
        </thead>
        <tbody>
          {% for key, label in [ ('performance_score','Performance'),
          ('accessibility_score','Accessibility'),
          ('security_score','Security'), ('functional_score','Functional'),
          ('ui_form_score','UI/Form') ] %} {% set v = var.get(key, {}) %}
          <tr
            class="{% if v.get('stddev') and v.get('stddev') > 20 %}intel-row--warn{% endif %}"
          >
            <td>{{ label }}</td>
            <td>
              <strong
                >{{ v.get('mean') if v.get('mean') is not none else '—'
                }}</strong
              >
            </td>
            <td>
              {{ v.get('stddev') if v.get('stddev') is not none else '—' }} {%
              if v.get('stddev') and v.get('stddev') > 20 %}
              <span class="intel-badge intel-badge--warn">High</span>
              {% endif %}
            </td>
            <td>{{ v.get('min') if v.get('min') is not none else '—' }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {# ── Top Failure Patterns
    ─────────────────────────────────────────────────── #} {% set patterns =
    intel.get('failure_patterns', []) %}
    <div class="intel-card">
      <div class="intel-card__title">
        <i class="fa-solid fa-triangle-exclamation"></i> Top Failure Patterns
      </div>
      {% if patterns %}
      <ol class="intel-list">
        {% for fp in patterns %}
        <li>
          <div class="intel-pattern-row">
            <span class="intel-badge intel-badge--{{ fp.severity_hint }}"
              >{{ fp.severity_hint }}</span
            >
            <span class="intel-pattern-tag"
              >{{ fp.root_cause_tag or 'untagged' }}</span
            >
            <span class="intel-count">×{{ fp.count }}</span>
          </div>
          <div class="intel-example-url">
            e.g.
            <a href="{{ fp.example_url }}" target="_blank" rel="noopener"
              >{{ fp.example_url | truncate(55) }}</a
            >
          </div>
        </li>
        {% endfor %}
      </ol>
      {% else %}
      <p class="intel-empty">
        <i class="fa-solid fa-circle-check" style="color: var(--success)"></i>
        No failure patterns detected.
      </p>
      {% endif %}
    </div>

    {# ── Most Unstable Page
    ───────────────────────────────────────────────────── #} {% set up =
    intel.get('unstable_page') %}
    <div
      class="intel-card {% if up and up.health_score and up.health_score < 50 %}intel-card--critical{% endif %}"
    >
      <div class="intel-card__title">
        <i class="fa-solid fa-circle-radiation"></i> Most Unstable Page
      </div>
      {% if up %}
      <a
        href="{{ up.url }}"
        target="_blank"
        rel="noopener"
        class="intel-unstable-url"
        >{{ up.url | truncate(65) }}</a
      >
      <div class="intel-unstable-stats">
        <div class="intel-stat-item">
          <span class="intel-stat-label">Health</span>
          <span
            class="intel-stat-value {% if up.health_score < 50 %}text-danger{% elif up.health_score < 75 %}text-warn{% else %}text-success{% endif %}"
            >{{ up.health_score }}</span
          >
        </div>
        <div class="intel-stat-item">
          <span class="intel-stat-label">Site Avg</span>
          <span class="intel-stat-value">{{ up.site_avg_health }}</span>
        </div>
        <div class="intel-stat-item">
          <span class="intel-stat-label">Deviation</span>
          <span class="intel-stat-value">±{{ up.deviation }}</span>
        </div>
      </div>
      {% if up.root_cause_tag %}
      <div class="intel-root-cause">
        Root cause: <code>{{ up.root_cause_tag }}</code>
      </div>
      {% endif %} {% else %}
      <p class="intel-empty">Insufficient data.</p>
      {% endif %}
    </div>

    {# ── Broken Link Source Map
    ───────────────────────────────────────────────── #} {% set blmap =
    intel.get('broken_link_map', []) %}
    <div class="intel-card">
      <div class="intel-card__title">
        <i class="fa-solid fa-link-slash"></i> Broken Nav Link Sources
      </div>
      {% if blmap %}
      <ul class="intel-list">
        {% for item in blmap[:5] %}
        <li>
          <div class="intel-source-url">
            {{ item.source_url | truncate(55) }}
          </div>
          <div class="intel-sub">
            {{ item.broken_count }} broken link{{ 's' if item.broken_count != 1
            }}: {% for bl in item.broken_links[:2] %}
            <code class="intel-code"
              >{{ bl.url | truncate(45) }}{% if bl.status %} ({{ bl.status }}){%
              endif %}</code
            >
            {% endfor %} {% if item.broken_links | length > 2 %}
            <span class="intel-more"
              >+{{ item.broken_links | length - 2 }} more</span
            >
            {% endif %}
          </div>
        </li>
        {% endfor %}
      </ul>
      {% else %}
      <p class="intel-empty">
        <i class="fa-solid fa-circle-check" style="color: var(--success)"></i>
        No broken navigation links.
      </p>
      {% endif %}
    </div>

    {# ── Risk Heatmap
    ─────────────────────────────────────────────────────────── #} {% set
    heatmap = intel.get('risk_heatmap', []) %} {% if heatmap %}
    <div class="intel-card intel-card--full">
      <div class="intel-card__title">
        <i class="fa-solid fa-fire"></i> Page Risk Heatmap
        <span class="intel-subtitle">(worst first)</span>
      </div>
      <div class="risk-heatmap-grid">
        {% for entry in heatmap %} {% set cat = entry.risk_category %} {% if cat
        == 'Excellent' %}{% set clr = '#10b981' %} {% elif cat == 'Good' %}{%
        set clr = '#84cc16' %} {% elif cat == 'Needs Attention' %}{% set clr =
        '#f59e0b' %} {% elif cat == 'Critical' %}{% set clr = '#ef4444' %} {%
        else %}{% set clr = '#94a3b8' %}{% endif %}
        <div
          class="heatmap-cell"
          style="border-color: {{ clr }}; background: {{ clr }}18;"
          title="{{ entry.url }}&#10;Health: {{ entry.health_score }}&#10;Broken nav: {{ entry.broken_nav }}&#10;JS errors: {{ entry.js_errors }}&#10;A11y: {{ entry.a11y_issues }}"
        >
          <div class="heatmap-score" style="color: {{ clr }};">
            {{ entry.health_score if entry.health_score is not none else '?' }}
          </div>
          <div class="heatmap-url">{{ entry.title | truncate(28) }}</div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}
  </div>
  {# end intel-grid #} {# Confidence tooltip enhancement via JS #} {% set ct =
  intel.get('confidence_tooltip', {}) %} {% if ct %}
  <script>
    (function() {
      var data = {{ ct | tojson }};
      var tipEl = document.querySelector('.conf-tooltip-text');
      if (!tipEl || !data.explanation) return;
      var lines = data.explanation.map(function(l) { return '• ' + l; }).join('<br>');
      var fac = data.factors || {};
      tipEl.innerHTML =
        '<strong>Confidence: ' + (data.score || '?') + '/100</strong><br>' +
        lines +
        '<br><small style="color:#94a3b8">Coverage: ' + (fac.crawl_coverage_pct || '?') +
        '% &nbsp;·&nbsp; Pages: ' + (fac.pages_scanned || '?') + '/' + (fac.pages_discovered || '?') + '</small>';
    })();
  </script>
  {% endif %} {% endif %}{# end if intel #}

  <style>
    /* ── Intelligence Panel — light theme matching index.html ──────────────────── */
    .intel-section-title {
      font-size: 13px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      color: var(--text-muted);
      margin: 24px 0 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .intel-section-title i {
      color: var(--primary);
    }

    .intel-banner {
      padding: 10px 16px;
      border-radius: var(--radius-sm);
      font-size: 13px;
      margin: 16px 0 8px;
      display: flex;
      align-items: center;
      gap: 10px;
      border: 1px solid;
    }
    .intel-banner--ok {
      background: #f0fdf4;
      border-color: #bbf7d0;
      color: #166534;
    }
    .intel-banner--caution {
      background: #fffbeb;
      border-color: #fde68a;
      color: #92400e;
    }
    .intel-banner--warn {
      background: #fef2f2;
      border-color: #fecaca;
      color: #991b1b;
    }
    .intel-tag {
      background: rgba(0, 0, 0, 0.07);
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      margin-left: auto;
    }

    .intel-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 14px;
      margin-bottom: 24px;
    }
    .intel-card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 16px;
      box-shadow: var(--shadow-sm);
    }
    .intel-card--chart {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .intel-card--full {
      grid-column: 1 / -1;
    }
    .intel-card--critical {
      border-color: #fca5a5;
      background: #fff5f5;
    }

    .intel-card__title {
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      color: var(--text-muted);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .intel-card__title i {
      color: var(--primary);
    }
    .intel-subtitle {
      font-weight: 400;
      text-transform: none;
      letter-spacing: 0;
      margin-left: 4px;
    }

    .intel-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    .intel-table th {
      color: var(--text-muted);
      font-weight: 600;
      text-align: left;
      padding: 4px 8px;
      border-bottom: 1px solid var(--border);
      font-size: 11px;
    }
    .intel-table td {
      padding: 5px 8px;
      color: var(--text-main);
      font-size: 12px;
    }
    .intel-row--warn td {
      color: #b45309;
    }

    .intel-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .intel-list li {
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
      font-size: 12px;
    }
    .intel-list li:last-child {
      border-bottom: none;
    }

    .intel-badge {
      display: inline-block;
      padding: 2px 7px;
      border-radius: 999px;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
    }
    .intel-badge--critical {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fca5a5;
    }
    .intel-badge--high {
      background: #fef3c7;
      color: #92400e;
      border: 1px solid #fde68a;
    }
    .intel-badge--warn {
      background: #fef3c7;
      color: #92400e;
      border: 1px solid #fde68a;
    }
    .intel-badge--medium {
      background: #eff6ff;
      color: #1e40af;
      border: 1px solid #bfdbfe;
    }

    .intel-pattern-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 3px;
    }
    .intel-pattern-tag {
      font-family: var(--font-code);
      font-size: 11px;
      color: var(--text-muted);
      flex: 1;
    }
    .intel-count {
      color: var(--text-muted);
      font-size: 11px;
      font-weight: 600;
    }
    .intel-example-url {
      font-size: 10px;
      color: var(--text-muted);
    }
    .intel-example-url a {
      color: var(--primary);
      text-decoration: none;
    }
    .intel-example-url a:hover {
      text-decoration: underline;
    }

    .intel-source-url {
      font-size: 12px;
      color: var(--text-main);
      font-weight: 500;
      margin-bottom: 4px;
    }
    .intel-sub {
      font-size: 11px;
      color: var(--text-muted);
      line-height: 1.6;
    }
    .intel-code {
      background: #f1f5f9;
      color: var(--danger);
      padding: 1px 5px;
      border-radius: 4px;
      font-family: var(--font-code);
      font-size: 10px;
      margin: 2px 2px 0 0;
      display: inline-block;
    }
    .intel-more {
      color: var(--primary);
      font-size: 10px;
      cursor: pointer;
    }
    .intel-empty {
      color: var(--text-muted);
      font-size: 12px;
      font-style: italic;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .intel-unstable-url {
      display: block;
      font-size: 12px;
      color: var(--primary);
      text-decoration: none;
      margin-bottom: 10px;
      word-break: break-all;
    }
    .intel-unstable-url:hover {
      text-decoration: underline;
    }
    .intel-unstable-stats {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }
    .intel-stat-item {
      display: flex;
      flex-direction: column;
    }
    .intel-stat-label {
      font-size: 10px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .intel-stat-value {
      font-size: 20px;
      font-weight: 800;
      color: var(--text-main);
      line-height: 1.1;
    }
    .text-danger {
      color: var(--danger) !important;
    }
    .text-warn {
      color: var(--warning) !important;
    }
    .text-success {
      color: var(--success) !important;
    }
    .intel-root-cause {
      font-size: 11px;
      color: var(--text-muted);
    }
    .intel-root-cause code {
      color: #7c3aed;
      font-family: var(--font-code);
      font-size: 11px;
    }

    /* Risk Heatmap */
    .risk-heatmap-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .heatmap-cell {
      width: 100px;
      padding: 10px 8px;
      border-radius: var(--radius-sm);
      border: 1.5px solid;
      cursor: default;
      transition:
        transform 0.15s,
        box-shadow 0.15s;
      text-align: center;
    }
    .heatmap-cell:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    .heatmap-score {
      font-size: 24px;
      font-weight: 800;
      line-height: 1;
    }
    .heatmap-url {
      font-size: 9px;
      color: var(--text-muted);
      margin-top: 4px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
  </style>
</head>
