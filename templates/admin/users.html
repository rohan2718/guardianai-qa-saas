{% extends "admin/base.html" %}
{% block title %}Users{% endblock %}
{% block page_title %}User Management{% endblock %}

{% block content %}
<form class="filter-bar fade-in-up" method="GET" action="/admin/users">
  <i class="fa-solid fa-users" style="color:var(--text-muted);font-size:13px;"></i>
  <input type="text" name="q" placeholder="Search username or email…" value="{{ q }}" style="min-width:220px;">
  <select name="plan">
    <option value="">All Plans</option>
    <option value="free"       {% if plan_filter=='free' %}selected{% endif %}>Free</option>
    <option value="pro"        {% if plan_filter=='pro' %}selected{% endif %}>Pro</option>
    <option value="enterprise" {% if plan_filter=='enterprise' %}selected{% endif %}>Enterprise</option>
  </select>
  <select name="status">
    <option value="">All Status</option>
    <option value="active"    {% if status_filter=='active' %}selected{% endif %}>Active</option>
    <option value="suspended" {% if status_filter=='suspended' %}selected{% endif %}>Suspended</option>
  </select>
  <button type="submit" class="btn btn-primary"><i class="fa-solid fa-filter"></i> Filter</button>
  {% if q or plan_filter or status_filter %}
  <a href="/admin/users" class="btn btn-outline"><i class="fa-solid fa-xmark"></i> Clear</a>
  {% endif %}
  <div style="flex:1;"></div>
  <a href="/admin/export/users" class="btn btn-outline btn-sm"><i class="fa-solid fa-download"></i> Export CSV</a>
</form>

<div class="card card-accent fade-in-up delay-1" style="padding:0;overflow:hidden;">
  <table class="data-table">
    <thead>
      <tr>
        <th>ID</th>
        <th>Username</th>
        <th>Email</th>
        <th>Plan</th>
        <th>Scans</th>
        <th>Joined</th>
        <th>Last Login</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for u in users %}
      <tr id="user-row-{{ u.id }}">
        <td style="font-family:var(--font-code);font-size:11px;color:var(--text-muted);">#{{ u.id }}</td>
        <td>
          <a href="/admin/users/{{ u.id }}" style="font-weight:700;font-size:13px;">{{ u.username }}</a>
          {% if u.is_admin %}<span class="badge badge-admin" style="margin-left:7px;">admin</span>{% endif %}
        </td>
        <td style="color:var(--text-muted);font-size:12px;">{{ u.email or '—' }}</td>
        <td><span class="badge badge-{{ u.plan }}">{{ u.plan }}</span></td>
        <td style="font-family:var(--font-code);font-weight:600;">{{ scan_counts.get(u.id, 0) }}</td>
        <td style="font-size:11px;color:var(--text-muted);font-family:var(--font-code);">
          {{ u.created_at.strftime('%d %b %Y') if u.created_at else '—' }}
        </td>
        <td style="font-size:11px;color:var(--text-muted);font-family:var(--font-code);">
          {{ u.last_login_at.strftime('%d %b %H:%M') if u.last_login_at else 'Never' }}
        </td>
        <td>
          <span class="badge {% if u._is_active %}badge-active{% else %}badge-suspended{% endif %}">
            {% if u._is_active %}Active{% else %}Suspended{% endif %}
          </span>
        </td>
        <td>
          <div style="display:flex;gap:6px;align-items:center;">
            <a href="/admin/users/{{ u.id }}" class="btn btn-outline btn-sm">View</a>
            {% if u.id != current_user.id %}
              {% if u._is_active %}
              <button class="btn btn-danger btn-sm" onclick="toggleUser({{ u.id }}, 'suspend')">Suspend</button>
              {% else %}
              <button class="btn btn-success btn-sm" onclick="toggleUser({{ u.id }}, 'activate')">Activate</button>
              {% endif %}
            {% endif %}
          </div>
        </td>
      </tr>
      {% else %}
      <tr>
        <td colspan="9" style="text-align:center;color:var(--text-muted);padding:56px;">
          <i class="fa-solid fa-users" style="font-size:28px;opacity:0.2;display:block;margin-bottom:12px;"></i>
          <div style="font-weight:600;margin-bottom:4px;">No users found</div>
          <div style="font-size:12px;">Try adjusting your filters</div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

{% if pagination.pages > 1 %}
<div class="pagination fade-in-up delay-2">
  {% if pagination.has_prev %}
  <a href="?page={{ pagination.prev_num }}&q={{ q }}&plan={{ plan_filter }}&status={{ status_filter }}">‹ Prev</a>
  {% endif %}
  {% for p in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
    {% if p %}
      {% if p == pagination.page %}
      <span class="current">{{ p }}</span>
      {% else %}
      <a href="?page={{ p }}&q={{ q }}&plan={{ plan_filter }}&status={{ status_filter }}">{{ p }}</a>
      {% endif %}
    {% else %}
      <span style="border:none;color:var(--text-muted);">…</span>
    {% endif %}
  {% endfor %}
  {% if pagination.has_next %}
  <a href="?page={{ pagination.next_num }}&q={{ q }}&plan={{ plan_filter }}&status={{ status_filter }}">Next ›</a>
  {% endif %}
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
function toggleUser(uid, action) {
  const label = action === 'suspend' ? 'Suspend' : 'Activate';
  if (!confirm(`${label} user #${uid}?`)) return;
  adminPost(`/admin/users/${uid}/${action}`, {}, d => {
    showToast(`User #${uid} ${action}d`, 'ok');
    setTimeout(() => location.reload(), 800);
  });
}
</script>
{% endblock %}